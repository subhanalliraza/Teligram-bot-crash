import websocket
import json
import time
import threading
import requests
import os
import sys

# Telegram bot config from environment variables
CHAT_ID = os.getenv("TELEGRAM_CHAT")
BOT_TOKEN = os.getenv("TELEGRAM_TOKEN")
WS_URL = os.getenv("WS_URL")

if not all([CHAT_ID, BOT_TOKEN, WS_URL]):
    print("Error: TELEGRAM_CHAT, TELEGRAM_TOKEN and WS_URL must be set", file=sys.stderr)
    sys.exit(1)

def send_telegram(msg):
    try:
        resp = requests.post(
            f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
            data={"chat_id": CHAT_ID, "text": msg}
        )
        resp.raise_for_status()
    except Exception as e:
        print(f"Telegram send error: {e}", file=sys.stderr)

def on_message(ws, message):
    try:
        data = json.loads(message)
    except json.JSONDecodeError:
        return

    # Ø¢Ù¾ ÛŒÛØ§Úº Game Event detect Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ logic Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº
    # ÙØ±Ø¶ Ú©Ø±ÛŒÚº 'new_round' Ø§ÛŒÙˆÙ†Ù¹ Ø¢ Ø¬Ø§Ø¦Û’:
    if isinstance(data, dict) and data.get("type") == "new_round":
        send_telegram("âš ï¸ Ù†ÛŒØ§ Ø±Ø§Ø¤Ù†Úˆ Ø´Ø±ÙˆØ¹ ÛÙˆÙ†Û’ ÙˆØ§Ù„Ø§ ÛÛ’ â€” 10 Ø³ÛŒÚ©Ù†Úˆ Ø¨Ø¹Ø¯!")
        time.sleep(10)
        send_telegram("ğŸ¯ Ø±Ø§Ø¤Ù†Úˆ Ø´Ø±ÙˆØ¹ ÛÙˆ Ú¯ÛŒØ§!")

def on_open(ws):
    send_telegram("ğŸš€ WebSocket Ø³Ú¯Ù†Ù„ Ø¨ÙˆÙ¹ ğŸš€: Ø´Ø±ÙˆØ¹ ÛÙˆ Ú¯ÛŒØ§")

def on_close(ws, close_status_code, close_msg):
    send_telegram("ğŸ›‘ Ø¨ÙˆÙ¹ Ø¨Ù†Ø¯ ÛÙˆ Ú¯ÛŒØ§")

def run_bot():
    ws = websocket.WebSocketApp(
        WS_URL,
        on_message=on_message,
        on_open=on_open,
        on_close=on_close
    )
    ws.run_forever()

if __name__ == "__main__":
    # 10 Ù…Ù†Ù¹ Ø¨Ø¹Ø¯ Ø¨Ù†Ø¯ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ ØªÚ¾Ø±ÛŒÚˆ
    bot_thread = threading.Thread(target=run_bot, daemon=True)
    bot_thread.start()

    # Ù…ÛŒÛŒÙ† ØªÚ¾Ø±ÛŒÚˆ Ø³Ù„ÛŒÙ¾ Ú©Ø±Û’ Ø§ÙˆØ± Ù¾Ú¾Ø± exit
    time.sleep(600)
    print("10 Ù…Ù†Ù¹ Ù¾ÙˆØ±Û’ ÛÙˆ Ú¯Ø¦Û’ØŒ Ø¨ÙˆÙ¹ Ø¨Ù†Ø¯ ÛÙˆ Ø±ÛØ§ ÛÛ’...")
    send_telegram("âŒ› 10 Ù…Ù†Ù¹ Ù…Ú©Ù…Ù„ ÛÙˆ Ú¯Ø¦Û’ â€” Ø¨ÙˆÙ¹ Ø¨Ù†Ø¯ ÛÙˆ Ø±ÛØ§ ÛÛ’")
    sys.exit(0)
