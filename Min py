import websocket
import json
import time
import threading
import requests
import os
import sys

# ğŸ”‘ Secrets
CHAT_ID = os.getenv("TELEGRAM_CHAT")
BOT_TOKEN = os.getenv("TELEGRAM_TOKEN")
WS_URL = os.getenv("WS_URL")
BOT_PASSWORD = os.getenv("BOT_PASSWORD")      # GitHub secret
INPUT_PASSWORD = os.getenv("INPUT_PASSWORD")  # Workflow input

# Ú†ÛŒÚ© Ú©Ø±ÛŒÚº Ú©Û Ø³Ø¨ Ú©Ú†Ú¾ Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’
if not all([CHAT_ID, BOT_TOKEN, WS_URL, BOT_PASSWORD, INPUT_PASSWORD]):
    print("âŒ Missing required environment variables", file=sys.stderr)
    sys.exit(1)

# ğŸ”’ Ù¾Ø§Ø³ÙˆØ±Úˆ Ù„Ø§Ú©
if INPUT_PASSWORD != BOT_PASSWORD:
    print("âŒ Wrong password! Bot will not start.")
    sys.exit(1)

def send_telegram(msg):
    """Ù¾ÛŒØºØ§Ù… Telegram Ù¾Ø± Ø¨Ú¾ÛŒØ¬ÛŒÚº"""
    try:
        resp = requests.post(
            f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
            data={"chat_id": CHAT_ID, "text": msg}
        )
        resp.raise_for_status()
    except Exception as e:
        print(f"Telegram send error: {e}", file=sys.stderr)

def on_message(ws, message):
    """Ø¬Ø¨ WebSocket Ø³Û’ Ù…ÛŒØ³Ø¬ Ù…Ù„Û’"""
    try:
        data = json.loads(message)
    except json.JSONDecodeError:
        return

    # ÛŒÛØ§Úº Ø§Ù¾Ù†Ø§ game event detection Ù„Ú¯Ø§Ø¦ÛŒÚº
    if isinstance(data, dict) and data.get("type") == "new_round":
        send_telegram("âš ï¸ Ù†ÛŒØ§ Ø±Ø§Ø¤Ù†Úˆ Ø´Ø±ÙˆØ¹ ÛÙˆÙ†Û’ ÙˆØ§Ù„Ø§ ÛÛ’ â€” 10 Ø³ÛŒÚ©Ù†Úˆ Ø¨Ø¹Ø¯!")
        time.sleep(10)
        send_telegram("ğŸ¯ Ø±Ø§Ø¤Ù†Úˆ Ø´Ø±ÙˆØ¹ ÛÙˆ Ú¯ÛŒØ§!")

def on_open(ws):
    send_telegram("ğŸš€ WebSocket Ø³Ú¯Ù†Ù„ Ø¨ÙˆÙ¹ Ø´Ø±ÙˆØ¹ ÛÙˆ Ú¯ÛŒØ§")

def on_close(ws, close_status_code, close_msg):
    send_telegram("ğŸ›‘ Ø¨ÙˆÙ¹ Ø¨Ù†Ø¯ ÛÙˆ Ú¯ÛŒØ§")

def run_bot():
    ws = websocket.WebSocketApp(
        WS_URL,
        on_message=on_message,
        on_open=on_open,
        on_close=on_close
    )
    ws.run_forever()

if __name__ == "__main__":
    bot_thread = threading.Thread(target=run_bot, daemon=True)
    bot_thread.start()

    # 10 Ù…Ù†Ù¹ Ø¨Ø¹Ø¯ Ø¨ÙˆÙ¹ Ø¨Ù†Ø¯ Ú©Ø± Ø¯ÛŒÚº
    time.sleep(600)
    print("âŒ› 10 Ù…Ù†Ù¹ Ù…Ú©Ù…Ù„ØŒ Ø¨ÙˆÙ¹ Ø¨Ù†Ø¯ ÛÙˆ Ø±ÛØ§ ÛÛ’...")
    send_telegram("âŒ› 10 Ù…Ù†Ù¹ Ù…Ú©Ù…Ù„ ÛÙˆ Ú¯Ø¦Û’ â€” Ø¨ÙˆÙ¹ Ø¨Ù†Ø¯ ÛÙˆ Ø±ÛØ§ ÛÛ’")
    sys.exit(0)
